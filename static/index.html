<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="static/css/styles.css">
</head>
<body>
    <input id="phoneNumberEntry" placeholder="Phone number"/>
    <button id="login" onclick="login()" style="display:none">Login</button>
    <h2 id="instructions"></h2>
    <div id="trackingDisplay">
        <h2 id="welcomeHeader">Welcome!</h2>
        <h3>Today's doses</h3>
        <h4 id="takeNow">Take now</h4>
        <div id="takeNowBody"></div>
        <h4 id="takeLater">Take later</h4>
        <div id="takeLaterBody"></div>
        <h3>Dose history</h3>
        <div>
            <table class="blueTable" id="calendar">
            </table>
        </div>
    </div>
    <script defer>
        var runningLocally = false;  // if this is false, you're editing PROD.
        var apiURL = runningLocally ? "http://localhost:5000" : "https://coherence-chat.herokuapp.com";
        const tracking = document.getElementById("trackingDisplay");
        const phoneNumberEntry = document.getElementById("phoneNumberEntry");
        const loginButton = document.getElementById("login");
        const welcomeHeader = document.getElementById("welcomeHeader");
        const takeNowBody = document.getElementById("takeNowBody");
        const takeLaterBody = document.getElementById("takeLaterBody");
        const calendar = document.getElementById("calendar");
        const instructions = document.getElementById("instructions");
        var adherenceHistory = {};
        const getInitDetails = {
            method: 'get',
            headers: {
                "Access-Control-Allow-Origin": "*",
                "Access-Control-Allow_Methods": "GET",
                "Access-Control_Allow_Headers": "*",
                "Cache-Control": "no-cache"
            },
            mode: "cors"
        };
        const postInitDetails = {
            method: 'post',
            headers: {
                "Access-Control-Allow-Origin": "*",
                "Access-Control-Allow_Methods": "POST",
                "Access-Control_Allow_Headers": "*",
                "Content-Type": "application/json; charset=utf-8",
                "Cache-Control": "no-cache"
            },
            mode: "cors",
        };
        function requestData() {
            fetch(`${apiURL}/patientData`, getInitDetails).then(response => response.json()).then(result => {
                console.log(result);
                if (!result.phoneNumber) {
                    instructions.innerHTML = "you need to login";
                    phoneNumberEntry.style.display = "block";
                    loginButton.style.display = "block";
                    tracking.style.display = "none";
                } else {
                    instructions.style.display = "none";
                    welcomeHeader.innerHTML = `Welcome, ${result.patientName}.`;
                    phoneNumberEntry.style.display = "none";
                    loginButton.style.display = "none";
                    tracking.style.display = "block";
                    adherenceHistory = getAdherentDaysInApril(result.eventData);
                    generateCalendar();
                }
            });
        }
        function getAdherentDaysInApril(eventData) {
            const fieldsToSatisfy = Object.keys(eventData);
            let adherentDays = [];
            let adherentWithSkipDays = [];
            let missedDays = [];
            let insufficientDataDays = [];
            for (let dayOfMonth = 1; dayOfMonth <= 30; dayOfMonth++) {
                const startDate = new Date(2021, 3, dayOfMonth, 7, 0, 0, 0); // start time in GMT
                const endDate = new Date(2021, 3, dayOfMonth + 1, 7, 0, 0, 0); // end time in GMT
                const satisfiedFields = [];
                const skippedFields = [];
                const missedFields = [];
                for (const field of fieldsToSatisfy) {
                    const eventDataForField = eventData[field];
                    for (const event of eventDataForField.events) {
                        const eventTimeObj = new Date(event.event_time);
                        if (eventTimeObj > startDate && eventTimeObj < endDate) {
                            if (event.event_type === "take") {
                                satisfiedFields.push(event);
                            } else if (event.event_type === "skip") {
                                skippedFields.push(event);
                            } else if (event.event_type === "boundary") {
                                missedFields.push(event);
                            }
                        }
                    }
                }
                console.log(satisfiedFields);
                console.log(skippedFields);
                console.log(missedFields);
                if (satisfiedFields.length == fieldsToSatisfy.length) {
                    adherentDays.push(dayOfMonth);
                } else if (satisfiedFields.length + skippedFields.length == fieldsToSatisfy.length) {
                    adherentWithSkipDays.push(dayOfMonth);
                } else if (satisfiedFields.length + skippedFields.length + missedFields.length == fieldsToSatisfy.length) {
                    missedDays.push(dayOfMonth);
                } else {
                    insufficientDataDays.push(dayOfMonth);
                }
            }
            console.log({ adherentDays, adherentWithSkipDays, missedDays, insufficientDataDays });
            return { adherentDays, adherentWithSkipDays, missedDays, insufficientDataDays };
        }
        function generateCalendar() {
            var htmlBlob = `
            <thead>
                <tr>
                    <th>Sun</th>
                    <th>Mon</th>
                    <th>Tues</th>
                    <th>Wed</th>
                    <th>Thurs</th>
                    <th>Fri</th>
                    <th>Sat</th>
                </tr>
                </thead>
                <tbody>
            `;
            const dates = [
                ["*28", "*29", "*30", "*31", "1", "2", "3"],
                ["4", "5", "6", "7", "8", "9", "10"],
                ["11", "12", "13", "14", "15", "16", "17"],
                ["18", "19", "20", "21", "22", "23", "24"],
                ["25", "26", "27", "28", "29", "30", "*1"],
            ]
            for (const dateRow of dates) {
                htmlBlob += "<tr>";
                for (const date of dateRow) {
                    var faded = false;
                    var processedDate = date;
                    var adherenceClass = "noAdherenceData";
                    const dayOfMonth = parseInt(processedDate);
                    if (adherenceHistory.adherentDays.includes(dayOfMonth)) {
                        adherenceClass = "adherent";
                    } else if (adherenceHistory.missedDays.includes(dayOfMonth)) {
                        adherenceClass = "nonadherent";
                    } else if (adherenceHistory.adherentWithSkipDays.includes(dayOfMonth)) {
                        adherenceClass = "adherentWithSkip";
                    }
                    if (date.includes("*")) {
                        faded = true;
                        processedDate = date.slice(1);
                    }
                    htmlBlob += `<td class='${faded ? "fadedDate " : ""}${adherenceClass}'>${processedDate}</td>`;
                }
                htmlBlob += "</tr>";
            }
            htmlBlob += `
                </tbody>
                </tr>
            `;
            calendar.innerHTML = htmlBlob;

        }
        function login() {
            const initDetails = {...postInitDetails, body: JSON.stringify({phoneNumber: phoneNumberEntry.value})}
            fetch(`${apiURL}/login`, initDetails).then(() => {requestData()});
        }
        requestData();
    </script>
</body>