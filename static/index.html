<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="static/css/styles.css">
</head>
<body>
    <p id="instructions"></p>
    <input id="phoneNumberEntry" placeholder="Phone number"/>
    <button id="login" onclick="login()" style="display:none">Login</button>
    <div id="trackingDisplay">
        <h2 id="welcomeHeader">Welcome!</h2>
        <h3>Dose history</h3>
        <p>Click on a day to see more details.</p>
        <div>
            <table class="blueTable" id="calendar">
            </table>
            <div>
                <h4>Key</h4>
                <div class="currentDate" style="padding:10px"><p>Current day</p></div>
                <p>ðŸŸ© All doses taken</p>
                <p>ðŸŸ§ Skipped some doses</p>
                <p>ðŸŸ¥ Missed some doses</p>
            </div>
        </div>
        <div class="modal" id="detailView">
            <div class="modal-content">
                <span class="close" id="closeButton">&times;</span>
                <h2 id="modalTitle"></h2>
                <div id="modalBody"></div>
            </div>
        </div>
    </div>
    <script defer>
        var runningLocally = false;
        var apiURL = runningLocally ? "http://localhost:5000" : "https://coherence-chat.herokuapp.com";
        const tracking = document.getElementById("trackingDisplay");
        const phoneNumberEntry = document.getElementById("phoneNumberEntry");
        const loginButton = document.getElementById("login");
        const welcomeHeader = document.getElementById("welcomeHeader");
        const takeNowBody = document.getElementById("takeNowBody");
        const takeLaterBody = document.getElementById("takeLaterBody");
        const calendar = document.getElementById("calendar");
        const instructions = document.getElementById("instructions");
        const modalCloseButton = document.getElementById("closeButton");
        const modal = document.getElementById("detailView");
        // modal controls
        // When the user clicks on <span> (x), close the modal
        modalCloseButton.onclick = function() {
            modal.style.display = "none";
        }
        // When the user clicks anywhere outside of the modal, close it
        window.onclick = function(event) {
            if (event.target == modal) {
                modal.style.display = "none";
            }
        }
        var adherenceHistory = {};
        const getInitDetails = {
            method: 'get',
            headers: {
                "Access-Control-Allow-Origin": "*",
                "Access-Control-Allow_Methods": "GET",
                "Access-Control_Allow_Headers": "*",
                "Cache-Control": "no-cache"
            },
            mode: "cors"
        };
        const postInitDetails = {
            method: 'post',
            headers: {
                "Access-Control-Allow-Origin": "*",
                "Access-Control-Allow_Methods": "POST",
                "Access-Control_Allow_Headers": "*",
                "Content-Type": "application/json; charset=utf-8",
                "Cache-Control": "no-cache"
            },
            mode: "cors",
        };
        function requestData() {
            fetch(`${apiURL}/patientData`, getInitDetails).then(response => response.json()).then(result => {
                if (!result.phoneNumber) {
                    if (result.error) {
                        instructions.innerHTML = result.error;
                    } else {
                        instructions.innerHTML = "Login with your phone number (ex: 1234567890)";
                    }
                    phoneNumberEntry.style.display = "block";
                    loginButton.style.display = "block";
                    tracking.style.display = "none";
                } else {
                    instructions.style.display = "none";
                    welcomeHeader.innerHTML = `Welcome, ${result.patientName}.`;
                    phoneNumberEntry.style.display = "none";
                    loginButton.style.display = "none";
                    tracking.style.display = "block";
                    adherenceHistory = processEventData(result.eventData);
                    generateCalendar();
                }
            });
        }
        // TODO: move this processing to the backend
        function processEventData(eventData) {
            const fieldsToSatisfy = Object.keys(eventData);
            let adherentDays = [];
            let adherentWithSkipDays = [];
            let missedDays = [];
            let insufficientDataDays = [];
            const takeHistoryByDay = {};
            for (let dayOfMonth = 1; dayOfMonth <= 30; dayOfMonth++) {
                // 2AM - 2AM to account for night doses
                const startDate = new Date(2021, 3, dayOfMonth, 2, 0, 0, 0); // start time in GMT
                const endDate = new Date(2021, 3, dayOfMonth + 1, 2, 0, 0, 0); // end time in GMT
                const satisfiedFields = [];
                const skippedFields = [];
                const missedFields = [];
                takeHistoryByDay[dayOfMonth] = {}
                for (const field of fieldsToSatisfy) {
                    const eventDataForField = eventData[field];
                    for (const event of eventDataForField.events) {
                        const eventTimeObj = new Date(event.event_time);
                        if (eventTimeObj > startDate && eventTimeObj < endDate) {
                            if (event.event_type === "take") {
                                satisfiedFields.push(event);
                            } else if (event.event_type === "skip") {
                                skippedFields.push(event);
                            } else if (event.event_type === "boundary") {
                                missedFields.push(event);
                            }
                            takeHistoryByDay[dayOfMonth][field] = {"eventType": event.event_type, "eventTime": event.event_time};
                        }
                    }
                }
                if (satisfiedFields.length == fieldsToSatisfy.length) {
                    adherentDays.push(dayOfMonth);
                } else if (satisfiedFields.length + skippedFields.length == fieldsToSatisfy.length) {
                    adherentWithSkipDays.push(dayOfMonth);
                } else if (satisfiedFields.length + skippedFields.length + missedFields.length == fieldsToSatisfy.length) {
                    missedDays.push(dayOfMonth);
                } else {
                    insufficientDataDays.push(dayOfMonth);
                }
            }
            return { adherentDays, adherentWithSkipDays, missedDays, insufficientDataDays, takeHistoryByDay};
        }
        function convertTZ(date, tzString) {
            return (typeof date === "string" ? new Date(date) : date).toLocaleString("en-US", {timeZone: tzString, hour: 'numeric', minute: 'numeric', hour12: true});
        }
        function getEventHTML(timeOfDayData) {
            const eventType = timeOfDayData.eventType;
            const eventTime = timeOfDayData.eventTime;
            if (eventType === "boundary") {
                return "<p class=missedDose>ðŸ›‘ Missed</p>";
            } else if (eventType === "take") {
                const eventTimeString = convertTZ(eventTime, "US/Pacific");
                return `<p class=takenDose>âœ… Taken at ${eventTimeString}</p>`;
            } else if (eventType === "skip") {
                return "<p class=skippedDose>ðŸŸ  Skipped</p>";
            }
            return "";
        }
        function openTableDetails(dayOfMonth) {
            const dayOfMonthData = adherenceHistory.takeHistoryByDay[dayOfMonth];
            const modalTitle = document.getElementById("modalTitle");
            const modalBody = document.getElementById("modalBody");
            const timeOfDayCopyMap = {
                morning: "Morning dose",
                afternoon: "Afternoon dose",
                evening: "Evening dose"
            }
            modalTitle.innerHTML = `April ${dayOfMonth}`;
            modalBodyHTML = "";
            if (Object.keys(dayOfMonthData).length !== 0) {
                const timeOfDayOrder = ["morning", "afternoon", "evening"];
                for (let timeOfDay of timeOfDayOrder) {
                    if (timeOfDay in dayOfMonthData) {
                        const timeOfDayHTML = `<h3>${timeOfDayCopyMap[timeOfDay]}</h3>${getEventHTML(dayOfMonthData[timeOfDay])}`;
                        modalBodyHTML += timeOfDayHTML;
                    }
                }
                modalBody.innerHTML = modalBodyHTML;
            } else {
                modalBody.innerHTML = "<p>No dose data for this day.</p>";
            }
            modal.style.display = "block";
            modal.style.display = "block";

        }
        function generateCalendar() {
            var htmlBlob = `
            <thead>
                <tr>
                    <th>Sun</th>
                    <th>Mon</th>
                    <th>Tues</th>
                    <th>Wed</th>
                    <th>Thurs</th>
                    <th>Fri</th>
                    <th>Sat</th>
                </tr>
                </thead>
                <tbody>
            `;
            const dates = [
                ["*28", "*29", "*30", "*31", "1", "2", "3"],
                ["4", "5", "6", "7", "8", "9", "10"],
                ["11", "12", "13", "14", "15", "16", "17"],
                ["18", "19", "20", "21", "22", "23", "24"],
                ["25", "26", "27", "28", "29", "30", "*1"],
            ]
            const currentDate = new Date();
            const currentDayOfMonth = currentDate.getDate();
            for (const dateRow of dates) {
                htmlBlob += "<tr>";
                for (const date of dateRow) {
                    var faded = false;
                    var processedDate = date;
                    var adherenceClass = "noAdherenceData";
                    const dayOfMonth = parseInt(processedDate);
                    if (adherenceHistory.adherentDays.includes(dayOfMonth)) {
                        adherenceClass = "adherent";
                    } else if (adherenceHistory.missedDays.includes(dayOfMonth)) {
                        adherenceClass = "nonadherent";
                    } else if (adherenceHistory.adherentWithSkipDays.includes(dayOfMonth)) {
                        adherenceClass = "adherentWithSkip";
                    }
                    if (dayOfMonth === currentDayOfMonth) {
                        adherenceClass += " currentDate";
                    }
                    if (date.includes("*")) {
                        faded = true;
                        processedDate = date.slice(1);
                    }
                    const onClickCall = faded ? "" : ` onclick=openTableDetails(${processedDate})`;
                    htmlBlob += `<td class='${faded ? "fadedDate " : ""}${adherenceClass}'${onClickCall}>${processedDate}</td>`;
                }
                htmlBlob += "</tr>";
            }
            htmlBlob += `
                </tbody>
                </tr>
            `;
            calendar.innerHTML = htmlBlob;
        }
        function login() {
            const initDetails = {...postInitDetails, body: JSON.stringify({phoneNumber: phoneNumberEntry.value})}
            fetch(`${apiURL}/login`, initDetails).then(() => {requestData()});
        }
        requestData();
    </script>
</body>