<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="static/css/styles.css">
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Lora&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Didact+Gothic&display=swap" rel="stylesheet">
</head>
<body style="background-color: rgb(233, 231, 220);">
    <div id="loginScreen" style="display:none; height:100%; flex-direction: column;">
        <div id="loginTopSection" style="background-color: #002864; display:flex; flex:1; flex-direction: column; align-items: center; justify-content: space-around;">
            <div style="align-items: center; display:flex; flex-direction: column;">
                <h2 style="color:#FBECB7; margin:0;">Coherence</h2>
                <p style="color:#FBECB7; margin:2px;">peace of mind for your medication</p>
            </div>
            <img src="static/svg/yellowstar.svg" style="width: 100px; padding-bottom: 20px;"/>
        </div>
        <div id="loginBottomSection" style="background-color: #FBECB7;display:flex; flex:2; flex-direction: column; align-items: center;">
            <img src="static/svg/swooplines.svg" style="width: 100%; padding-top: 20px;"/>
        </div>
        <div id="loginBox" style="position: absolute; top: 50%; left: 50%; transform: translateX(-50%) translateY(-50%); display:flex; flex-direction: column; align-items: center;">
            <p id="phoneNumberEntryInstructions" style="text-align: center; font-size: 12px;"></p>
            <input id="phoneNumberEntry" placeholder="Phone number" style="padding: 10px; border-color: #002864; font-family: 'Lora', serif;"/>
            <button id="login" onclick="enterPhoneNumber()" style="background-color: #002864; color: #FBECB7; border: none; padding-top: 15px; padding-bottom: 15px; margin: 15px; border-radius: 30px; font-family: 'Lora', serif;">Enter</button>
        </div>
        <div>
            <div id="loginBox2" style="position: absolute; top: 50%; left: 50%; transform: translateX(-50%) translateY(-50%); display:none; flex-direction: column; align-items: center;">
                <p style="text-align: center;" id="codeEntryInstructions">We've texted you a secret code. Enter that here to login.</p>
                <input id="secretCodeEntry" placeholder="Secret 6-digit code" style="padding: 10px; border-color: #002864; font-family: 'Lora', serif;"/>
                <button id="login" onclick="login()" style="background-color: #002864; color: #FBECB7; border: none; padding-top: 15px; padding-bottom: 15px; margin: 15px; border-radius: 30px; font-family: 'Lora', serif;">Login</button>
            </div>

        </div>
    </div>
    <div id="trackingDisplay">
        <div style="background-color: #002864; padding: 20px">
            <h2 id="welcomeHeader" style="color:white">Welcome!</h2>
            <h4 id="takeNow" style="text-align: center; padding:10px; border-radius: 10px;"></h4>
            <!-- <button onclick="logout()">Log out (testing only)</button> -->
        </div>
        <div style="background-color: rgb(233, 231, 220); padding: 10px">
            <h3>Dose history</h3>
            <p>Click on a day to see more details.</p>
            <div>
                <table class="blueTable" id="calendar">
                </table>
                <div style="display:flex; flex-direction: row; justify-content: space-between;">
                    <div>
                        <h4>Key</h4>
                        <div class="currentDate" style="padding:10px"><p>Today</p></div>
                        <div class="legendContainer"><div class='box green'></div> <p>All doses taken</p></div>
                        <div class="legendContainer"><div class='box orange'></div><p>Skipped some doses</p></div>
                        <div class="legendContainer"><div class='box red'></div><p>Missed some doses</p></div>
                    </div>
                    <img src="static/svg/bluestar.svg" style="width:70px; align-self:flex-end; padding: 20px"/>
                </div>
            </div>
            <div class="modal" id="detailView">
                <div class="modal-content">
                    <span class="close" id="closeButton">&times;</span>
                    <h2 id="modalTitle"></h2>
                    <div id="modalBody"></div>
                </div>
            </div>
        </div>
    </div>
    <script defer>
        var runningLocally = false;
        var apiURL = runningLocally ? "http://localhost:5000" : "https://coherence-chat.herokuapp.com";
        const tracking = document.getElementById("trackingDisplay");
        const loginScreen = document.getElementById("loginScreen");
        const phoneNumberEntry = document.getElementById("phoneNumberEntry");
        const secretCodeEntry = document.getElementById("secretCodeEntry");
        const loginButton = document.getElementById("login");
        const welcomeHeader = document.getElementById("welcomeHeader");
        const takeNowBody = document.getElementById("takeNowBody");
        const takeLaterBody = document.getElementById("takeLaterBody");
        const calendar = document.getElementById("calendar");
        const phoneNumberEntryInstructions = document.getElementById("phoneNumberEntryInstructions");
        const codeEntryInstructions = document.getElementById("codeEntryInstructions");
        const modalCloseButton = document.getElementById("closeButton");
        const modal = document.getElementById("detailView");
        const takeNow = document.getElementById("takeNow");
        const allTakenCopy = [
            "Nothing to take at the moment, you're all clear. üëç",
            "No dose to take right now. ‚≠ê",
            "No medications to worry about right now. üôÇ",
            "No medications to take for now. ‚úÖ",
        ]
        // modal controls
        // When the user clicks on <span> (x), close the modal
        modalCloseButton.onclick = function() {
            modal.style.display = "none";
        }
        // When the user clicks anywhere outside of the modal, close it
        window.onclick = function(event) {
            if (event.target == modal) {
                modal.style.display = "none";
            }
        }
        var adherenceHistory = {};
        const getInitDetails = {
            method: 'get',
            headers: {
                "Access-Control-Allow-Origin": "*",
                "Access-Control-Allow_Methods": "GET",
                "Access-Control_Allow_Headers": "*",
                "Cache-Control": "no-cache"
            },
            mode: "cors"
        };
        const postInitDetails = {
            method: 'post',
            headers: {
                "Access-Control-Allow-Origin": "*",
                "Access-Control-Allow_Methods": "POST",
                "Access-Control_Allow_Headers": "*",
                "Content-Type": "application/json; charset=utf-8",
                "Cache-Control": "no-cache"
            },
            mode: "cors",
        };
        function randomChoice(arr) {
            return arr[Math.floor(arr.length * Math.random())];
        }
        function requestData() {
            fetch(`${apiURL}/patientData`, getInitDetails).then(response => response.json()).then(result => {
                if (result.phoneNumber) {
                    loginScreen.style.display = "none";
                    welcomeHeader.innerHTML = `Welcome, ${result.patientName}.`;
                    tracking.style.display = "block";
                    if (result.takeNow) {
                        takeNow.innerHTML = "You have a dose to take now."
                        takeNow.style.backgroundColor = "#f54242";
                        takeNow.style.color= "#FFF";
                    } else {
                        takeNow.innerHTML = randomChoice(allTakenCopy);
                        takeNow.style.backgroundColor = "#09ad56";
                        takeNow.style.color = "#FFF";
                    }
                    adherenceHistory = processEventData(result.eventData);
                    generateCalendar();
                } else {
                    loginScreen.style.display = "flex";
                    tracking.style.display = "none";
                }
            });
        }
        // TODO: move this processing to the backend
        function processEventData(eventData) {
            const fieldsToSatisfy = Object.keys(eventData);
            let adherentDays = [];
            let adherentWithSkipDays = [];
            let missedDays = [];
            let insufficientDataDays = [];
            const takeHistoryByDay = {};
            const doseDataByTime = {}
            for (let dayOfMonth = 1; dayOfMonth <= 30; dayOfMonth++) {
                // 2AM - 2AM to account for night doses
                const startDate = new Date(2021, 3, dayOfMonth, 2, 0, 0, 0); // start time in GMT
                const endDate = new Date(2021, 3, dayOfMonth + 1, 2, 0, 0, 0); // end time in GMT
                const satisfiedFields = [];
                const skippedFields = [];
                const missedFields = [];
                takeHistoryByDay[dayOfMonth] = {}
                for (const field of fieldsToSatisfy) {
                    const eventDataForField = eventData[field];
                    for (const event of eventDataForField.events) {
                        const eventTimeObj = new Date(event.event_time);
                        if (eventTimeObj > startDate && eventTimeObj < endDate) {
                            if (event.event_type === "take") {
                                satisfiedFields.push(event);
                            } else if (event.event_type === "skip") {
                                skippedFields.push(event);
                            } else if (event.event_type === "boundary") {
                                missedFields.push(event);
                            }
                            takeHistoryByDay[dayOfMonth][field] = {"eventType": event.event_type, "eventTime": event.event_time};
                        }
                    }
                    if (!(field in doseDataByTime)) {
                        doseDataByTime[field] = eventData[field].dose;
                    }
                }
                if (satisfiedFields.length == fieldsToSatisfy.length) {
                    adherentDays.push(dayOfMonth);
                } else if (satisfiedFields.length + skippedFields.length == fieldsToSatisfy.length) {
                    adherentWithSkipDays.push(dayOfMonth);
                } else if (satisfiedFields.length + skippedFields.length + missedFields.length == fieldsToSatisfy.length) {
                    missedDays.push(dayOfMonth);
                } else {
                    insufficientDataDays.push(dayOfMonth);
                }
            }
            return { adherentDays, adherentWithSkipDays, missedDays, insufficientDataDays, takeHistoryByDay, doseDataByTime};
        }
        function convertTZ(date, tzString) {
            return (typeof date === "string" ? new Date(date) : date).toLocaleString("en-US", {timeZone: tzString, hour: 'numeric', minute: 'numeric', hour12: true});
        }
        function getEventHTML(timeOfDayData) {
            const eventType = timeOfDayData.eventType;
            const eventTime = timeOfDayData.eventTime;
            if (eventType === "boundary") {
                return "<p class=missedDose>üõë Missed</p>";
            } else if (eventType === "take") {
                const eventTimeString = convertTZ(eventTime, "US/Pacific");
                return `<p class=takenDose>‚úÖ Taken at ${eventTimeString}</p>`;
            } else if (eventType === "skip") {
                return "<p class=skippedDose>üü† Skipped</p>";
            }
            return "";
        }
        function openTableDetails(dayOfMonth) {
            const dayOfMonthData = adherenceHistory.takeHistoryByDay[dayOfMonth];
            const modalTitle = document.getElementById("modalTitle");
            const modalBody = document.getElementById("modalBody");
            const timeOfDayCopyMap = {
                morning: "Morning dose",
                afternoon: "Afternoon dose",
                evening: "Evening dose"
            }
            modalTitle.innerHTML = `April ${dayOfMonth}`;
            modalBodyHTML = "";
            if (Object.keys(dayOfMonthData).length !== 0) {
                const timeOfDayOrder = ["morning", "afternoon", "evening"];
                for (let timeOfDay of timeOfDayOrder) {
                    if (timeOfDay in dayOfMonthData) {
                        const timeOfDayHTML = `<h3>${timeOfDayCopyMap[timeOfDay]}</h3>${adherenceHistory.doseDataByTime[timeOfDay].medication_name ? `<p>üíä<span style="font-size:15px">${adherenceHistory.doseDataByTime[timeOfDay].medication_name}</span></p>` : ""}${getEventHTML(dayOfMonthData[timeOfDay])}`;
                        modalBodyHTML += timeOfDayHTML;
                    }
                }
                modalBody.innerHTML = modalBodyHTML;
            } else {
                modalBody.innerHTML = "<p>No dose data for this day.</p>";
            }
            modal.style.display = "block";
            modal.style.display = "block";

        }
        function generateCalendar() {
            var htmlBlob = `
            <thead>
                <tr>
                    <th>Sun</th>
                    <th>Mon</th>
                    <th>Tue</th>
                    <th>Wed</th>
                    <th>Thu</th>
                    <th>Fri</th>
                    <th>Sat</th>
                </tr>
                </thead>
                <tbody>
            `;
            const dates = [
                ["*28", "*29", "*30", "*31", "1", "2", "3"],
                ["4", "5", "6", "7", "8", "9", "10"],
                ["11", "12", "13", "14", "15", "16", "17"],
                ["18", "19", "20", "21", "22", "23", "24"],
                ["25", "26", "27", "28", "29", "30", "*1"],
            ]
            const currentDate = new Date();
            const currentDayOfMonth = currentDate.getDate();
            for (const dateRow of dates) {
                htmlBlob += "<tr>";
                for (const date of dateRow) {
                    var faded = false;
                    var processedDate = date;
                    var adherenceClass = "noAdherenceData";
                    const dayOfMonth = parseInt(processedDate);
                    if (adherenceHistory.adherentDays.includes(dayOfMonth)) {
                        adherenceClass = "adherent";
                    } else if (adherenceHistory.missedDays.includes(dayOfMonth)) {
                        adherenceClass = "nonadherent";
                    } else if (adherenceHistory.adherentWithSkipDays.includes(dayOfMonth)) {
                        adherenceClass = "adherentWithSkip";
                    }
                    if (dayOfMonth === currentDayOfMonth) {
                        adherenceClass += " currentDate";
                    }
                    if (date.includes("*")) {
                        faded = true;
                        processedDate = date.slice(1);
                    }
                    const onClickCall = faded ? "" : ` onclick=openTableDetails(${processedDate})`;
                    htmlBlob += `<td class='${faded ? "fadedDate " : ""}${adherenceClass}'${onClickCall}>${processedDate}</td>`;
                }
                htmlBlob += "</tr>";
            }
            htmlBlob += `
                </tbody>
                </tr>
            `;
            calendar.innerHTML = htmlBlob;
        }
        function enterPhoneNumber() {
            const initDetails = {...postInitDetails, body: JSON.stringify({phoneNumber: phoneNumberEntry.value})}
            fetch(`${apiURL}/login/requestCode`, initDetails).then((response) => {
                if (response.status === 200) {
                    const phoneEntryBox = document.getElementById("loginBox");
                    const codeEntryBox = document.getElementById("loginBox2");
                    phoneEntryBox.style.display = "none";
                    codeEntryBox.style.display = "flex";
                } else {
                    phoneNumberEntryInstructions.innerHTML = "We couldn't find your phone number in our records. Please make sure you've entered it correctly.";
                }
            });
        }
        function login() {
            const codeEntry = document.getElementById("secretCodeEntry");
            const initDetails = {...postInitDetails, body: JSON.stringify({phoneNumber: phoneNumberEntry.value, code: codeEntry.value})}
            fetch(`${apiURL}/login`, initDetails).then((response) => {
                if (response.status === 200) {
                    requestData();
                } else {
                    codeEntryInstructions.innerHTML = "Secret code was incorrect. Double check to make sure you've entered it correctly.";
                }

            });
        }
        function logout() {
            fetch(`${apiURL}/logout`, getInitDetails).then(() => {
                requestData();
            })
        }
        requestData();
    </script>
</body>