<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="static/css/styles.css">
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Lora&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Didact+Gothic&display=swap" rel="stylesheet">
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
</head>
<body style="background-color: rgb(233, 231, 220);">
    <div id="loginScreen" style="display:none; height:100%; flex-direction: column;">
        <div id="loginTopSection" style="background-color: #002864; display:flex; flex:1; flex-direction: column; align-items: center; justify-content: space-around;">
            <div style="align-items: center; display:flex; flex-direction: column;">
                <h2 style="color:#FBECB7; margin:0;">Coherence</h2>
                <p style="color:#FBECB7; margin:2px;">peace of mind for your medication</p>
            </div>
            <img src="static/svg/yellowstar.svg" style="width: 100px; padding-bottom: 20px;"/>
        </div>
        <div id="loginBottomSection" style="background-color: #FBECB7;display:flex; flex:2; flex-direction: column; align-items: center;">
            <img src="static/svg/swooplines.svg" style="width: 100%; padding-top: 20px;"/>
        </div>
        <div id="loginBox" style="position: absolute; top: 50%; left: 50%; transform: translateX(-50%) translateY(-50%); display:flex; flex-direction: column; align-items: center;">
            <p id="phoneNumberEntryInstructions" style="text-align: center; font-size: 12px;"></p>
            <input id="phoneNumberEntry" placeholder="Phone number" style="padding: 10px; border-color: #002864; font-family: 'Lora', serif;"/>
            <button id="login" onclick="enterPhoneNumber()" style="background-color: #002864; color: #FBECB7; border: none; padding-top: 15px; padding-bottom: 15px; margin: 15px; border-radius: 30px; font-family: 'Lora', serif;">Enter</button>
        </div>
        <div>
            <div id="loginBox2" style="position: absolute; top: 50%; left: 50%; transform: translateX(-50%) translateY(-50%); display:none; flex-direction: column; align-items: center;">
                <p style="text-align: center;" id="codeEntryInstructions">We've texted you a secret code. Enter that here to login.</p>
                <input id="secretCodeEntry" placeholder="Secret 6-digit code" style="padding: 10px; border-color: #002864; font-family: 'Lora', serif;"/>
                <button id="login" onclick="login()" style="background-color: #002864; color: #FBECB7; border: none; padding-top: 15px; padding-bottom: 15px; margin: 15px; border-radius: 30px; font-family: 'Lora', serif;">Login</button>
            </div>

        </div>
    </div>
    <div id="trackingDisplay">
        <div style="background-color: #002864; padding: 20px">
            <h2 id="welcomeHeader" style="color:white">Welcome!</h2>
            <h4 id="takeNow" style="text-align: center; padding:10px; border-radius: 10px;"></h4>
            <!-- <button onclick="logout()">Log out (testing only)</button> -->
        </div>
        <div style="background-color: rgb(233, 231, 220); padding: 10px">
            <h3>Dose history</h3>
            <p>Click on a day to see more details.</p>
            <div>
                <table class="blueTable" id="calendar">
                </table>
                <div style="display:flex; flex-direction: row; justify-content: space-between;">
                    <div>
                        <h4>Key</h4>
                        <div class="currentDate" style="padding:10px"><p>Today</p></div>
                        <div class="legendContainer"><div class='box green'></div> <p>All doses taken</p></div>
                        <div class="legendContainer"><div class='box orange'></div><p>Skipped some doses</p></div>
                        <div class="legendContainer"><div class='box red'></div><p>Missed some doses</p></div>
                    </div>
                    <img src="static/svg/bluestar.svg" style="width:70px; align-self:flex-end; padding: 20px"/>
                </div>
            </div>
            <div class="modal" id="detailView">
                <div class="modal-content">
                    <span class="close" id="closeButton">&times;</span>
                    <h2 id="modalTitle"></h2>
                    <div id="modalBody"></div>
                </div>
            </div>
        </div>
        <div id="behaviorAnalysisSection" style="background-color: #002864; padding: 10px;">
            <h3 style="color: #FFF">Insights for you</h3>
            <div id="averageDoseTaken"></div>
            <div id="behaviorLearningChartTitle"></div>
            <div id="behaviorLearningChart"></div>
        </div>
        <div style="background-color: rgb(233, 231, 220); padding: 10px;">
            <h3>Dose windows</h3>
            <div id="doseWindows"></div>
        </div>
        <div id="servicePausedSection" style="display: flex; width: 100%; flex-direction: column; align-items: center; background-color: #002864; box-sizing: border-box; padding: 20px;">
            <h3 style="color:#FFF; align-self:center;">Current status: <span id="statusIndicator">active</span></h2>
            <p id="statusExplainer" style="color:#FFF; align-self:center; text-align: center; margin-top: 0px;">I'm currently texting you to help you stay on track with your medication!</p>
            <button id="pauseButton" onclick="pauseService()" style="background-color: #f54242; color: #FBECB7; border: none; padding-top: 15px; padding-bottom: 15px; margin: 15px; border-radius: 30px; font-family: 'Lora', serif; text-align: center; font-size: 20px;">Pause</button>
            <p id="buttonActionExplainer" style="color:#FFF; font-size:12px; text-align: center;">Pausing will still allow you to tell us when you've taken or skipped a medication, but we will no longer remind you to take it.</p>
        </div>
        <div style="background-color: rgb(233, 231, 220);">
            <h3>Need help with anything?</h3>
            <p>Text us at (650) 667-1146‚Ä¨, and we'll get back to you in less than one business day to help you out!</p>
        </div>
    </div>
    <script defer>
        // load line chart library
        google.charts.load('current', {'packages':['corechart']});
        var chartLibraryLoaded = false;
        google.charts.setOnLoadCallback(() => {chartLibraryLoaded = true});
        var runningLocally = false;
        var apiURL = runningLocally ? "http://localhost:5000" : "https://coherence-chat.herokuapp.com";
        const tracking = document.getElementById("trackingDisplay");
        const loginScreen = document.getElementById("loginScreen");
        const phoneNumberEntry = document.getElementById("phoneNumberEntry");
        const secretCodeEntry = document.getElementById("secretCodeEntry");
        const loginButton = document.getElementById("login");
        const welcomeHeader = document.getElementById("welcomeHeader");
        const takeNowBody = document.getElementById("takeNowBody");
        const takeLaterBody = document.getElementById("takeLaterBody");
        const calendar = document.getElementById("calendar");
        const phoneNumberEntryInstructions = document.getElementById("phoneNumberEntryInstructions");
        const codeEntryInstructions = document.getElementById("codeEntryInstructions");
        const modalCloseButton = document.getElementById("closeButton");
        const modal = document.getElementById("detailView");
        const takeNow = document.getElementById("takeNow");
        const statusIndicator = document.getElementById("statusIndicator");
        const pauseStatusExplainer = document.getElementById("statusExplainer");
        const pauseButton = document.getElementById("pauseButton");
        const buttonActionExplainer = document.getElementById("buttonActionExplainer");
        const allTakenCopy = [
            "Nothing to take at the moment, you're all clear. üëç",
            "No dose to take right now. ‚≠ê",
            "No medications to worry about right now. üôÇ",
            "No medications to take for now. ‚úÖ",
        ]
        // modal controls
        // When the user clicks on <span> (x), close the modal
        modalCloseButton.onclick = function() {
            modal.style.display = "none";
        }
        // When the user clicks anywhere outside of the modal, close it
        window.onclick = function(event) {
            if (event.target == modal) {
                modal.style.display = "none";
            }
        }
        var adherenceHistory = {};
        var activityAnalytics = {};
        var servicePaused = false;
        var doseWindows = [];
        const getInitDetails = {
            method: 'get',
            headers: {
                "Access-Control-Allow-Origin": "*",
                "Access-Control-Allow_Methods": "GET",
                "Access-Control_Allow_Headers": "*",
                "Cache-Control": "no-cache"
            },
            mode: "cors"
        };
        const postInitDetails = {
            method: 'post',
            headers: {
                "Access-Control-Allow-Origin": "*",
                "Access-Control-Allow_Methods": "POST",
                "Access-Control_Allow_Headers": "*",
                "Content-Type": "application/json; charset=utf-8",
                "Cache-Control": "no-cache"
            },
            mode: "cors",
        };
        function randomChoice(arr) {
            return arr[Math.floor(arr.length * Math.random())];
        }
        function requestData() {
            fetch(`${apiURL}/patientData`, getInitDetails).then(response => response.json()).then(result => {
                console.log(result);
                modal.style.display = "none";
                if (result.phoneNumber) {
                    loginScreen.style.display = "none";
                    welcomeHeader.innerHTML = `Welcome, ${result.patientName}.`;
                    tracking.style.display = "block";
                    if (result.takeNow) {
                        takeNow.innerHTML = "You have a dose to take now."
                        takeNow.style.backgroundColor = "#f54242";
                        takeNow.style.color= "#FFF";
                    } else {
                        takeNow.innerHTML = randomChoice(allTakenCopy);
                        takeNow.style.backgroundColor = "#09ad56";
                        takeNow.style.color = "#FFF";
                    }
                    adherenceHistory = processEventData(result.eventData);
                    activityAnalytics = {behaviorLearningScores: result.behaviorLearningScores};
                    servicePaused = result.pausedService;
                    doseWindows = result.doseWindows;
                    generateCalendar();
                    renderServicePaused();
                    renderAnalytics();
                    renderBehaviorLearningChart();
                    renderDoseWindows();
                } else {
                    loginScreen.style.display = "flex";
                    tracking.style.display = "none";
                }
            });
        }
        function checkTime(i) {
            if (i < 10) {
                i = "0" + i;
            }
            return i;
        }
        function renderDoseWindows() {
            const doseWindowDiv = document.getElementById("doseWindows");
            doseWindowDiv.innerHTML = '';
            for (const doseWindow of doseWindows) {
                let doseStartTime = new Date();
                let doseEndTime = new Date();
                doseStartTime.setUTCHours(doseWindow.start_hour, doseWindow.start_minute);
                doseEndTime.setUTCHours(doseWindow.end_hour, doseWindow.end_minute);
                const startTimeString = `${checkTime(doseStartTime.getHours())}:${checkTime(doseStartTime.getMinutes())}`;
                const endTimeString = `${checkTime(doseEndTime.getHours())}:${checkTime(doseEndTime.getMinutes())}`;
                const doseWindowHTML = `
                    <div style="display:flex; flex-direction:row; justify-content: space-between; padding: 5px;">
                        <p id="doseWindowTimeHeader-${doseWindow.id}" style="margin: 0;">${doseStartTime.toLocaleString('en-US', { hour: 'numeric', minute: 'numeric', hour12: true })} -> ${doseEndTime.toLocaleString('en-US', { hour: 'numeric', minute: 'numeric', hour12: true })}</p>
                        <div id="doseWindowEditingInterface-${doseWindow.id}" style="display: none; flex-direction: row; justify-content: space-between;">
                            <div>
                                <input type="time" id="updatedDoseStartTime-${doseWindow.id}" value="${checkTime(doseStartTime.getHours())}:${checkTime(doseStartTime.getMinutes())}"/>
                                <input type="time" id="updatedDoseEndTime-${doseWindow.id}" value="${checkTime(doseEndTime.getHours())}:${checkTime(doseEndTime.getMinutes())}"/>
                            </div>
                            <button id="updateDoseWindow-${doseWindow.id}" onclick="submitUpdateForDoseWindow(\'${doseWindow.id}\', \'${startTimeString}\', \'${endTimeString}\')" style="border-radius: 10px; padding-left:5px; padding-right:5px; background-color: #09ad56; border:0; font-family: Lora; color: #FFF;">Save changes</button>
                        </div>
                        <button id="editDoseWindow-${doseWindow.id}" onclick="startEditingDoseWindow(\'${doseWindow.id}\')" style="border-radius: 10px; padding-left:10px; padding-right:10px; background-color: #002864; color: #FFF; border:0; font-family: Lora;">Edit</button>
                    </div>
                `;
                doseWindowDiv.innerHTML += doseWindowHTML;
            }
        }
        // I don't know where to put these things
        // src: https://stackoverflow.com/questions/563406/add-days-to-javascript-date
        Date.prototype.addDays = function(days) {
            var date = new Date(this.valueOf());
            date.setDate(date.getDate() + days);
            return date;
        }
        function getTimeFromHourMinute(hour, minute, utc=false) {
            let time = new Date();
            let dayStart = new Date();
            if (dayStart.getHours() < 2) {
                dayStart.addDays(-1);
            }
            dayStart.setHours(2, 0, 0, 0); // 2 AM today.
            if (utc) {
                time.setUTCHours(hour, minute, 0, 0);
                console.log(time);
            } else {
                time.setHours(hour, minute, 0, 0);
            }
            if (time < dayStart) {  // UTC caused it to become the previous day.
                time = time.addDays(1);
            }
            if (time.getHours() < 2) {
                time = time.addDays(1);
            }
            return time
        }
        function checkDoseWindowIntegrity(updatedDoseWindow) {
            const { startHour, startMinute, endHour, endMinute, doseWindowId } = updatedDoseWindow;
            let newDwStartTime = getTimeFromHourMinute(startHour, startMinute);
            let newDwEndTime = getTimeFromHourMinute(endHour, endMinute);
            if (newDwEndTime <= newDwStartTime) {
                return "Dose window end time must be after start time."
            }
            const remainingDoseWindows = doseWindows.filter((dw) => {return dw.id != doseWindowId});
            for (const dw of remainingDoseWindows) {
                let existingDwStartTime = getTimeFromHourMinute(dw.start_hour, dw.start_minute, utc=true);
                let existingDwEndTime = getTimeFromHourMinute(dw.end_hour, dw.end_minute, utc=true);
                if (newDwStartTime < existingDwStartTime && newDwEndTime > existingDwStartTime) {
                    return "Dose windows cannot overlap.";
                }
                if (newDwStartTime < existingDwEndTime && newDwEndTime > existingDwEndTime) {
                    return "Dose windows cannot overlap.";
                }
            }
            return null;
        }
        function submitUpdateForDoseWindow(doseWindowId, previousStartTimeString, previousEndTimeString) {
            const startTimeString = document.getElementById(`updatedDoseStartTime-${doseWindowId}`).value;
            const endTimeString = document.getElementById(`updatedDoseEndTime-${doseWindowId}`).value;
            if (previousStartTimeString === startTimeString && previousEndTimeString === endTimeString) {
                // no changes, close editor
                stopEditingDoseWindow(doseWindowId);
                return;
            }
            const startHour = parseInt(startTimeString.split(":")[0]);
            const startMinute = parseInt(startTimeString.split(":")[1]);
            const endHour = parseInt(endTimeString.split(":")[0]);
            const endMinute = parseInt(endTimeString.split(":")[1]);
            const errorMessage = checkDoseWindowIntegrity({ startHour, startMinute, endHour, endMinute, doseWindowId: parseInt(doseWindowId) });
            let doseStartTime = new Date();
            doseStartTime.setHours(startHour, startMinute);
            const startTimeFormatted = doseStartTime.toLocaleString('en-US', { hour: 'numeric', minute: 'numeric', hour12: true });
            let doseEndTime = new Date();
            doseEndTime.setHours(endHour, endMinute);
            const endTimeFormatted = doseEndTime.toLocaleString('en-US', { hour: 'numeric', minute: 'numeric', hour12: true });
            if (errorMessage) {
                modalTitle.innerHTML = "Dose window error";
                modalBody.innerHTML = errorMessage;
            } else {
                modalTitle.innerHTML = "Dose window update confirmation";
                modalBody.innerHTML = `
                    <div style="display:flex; align-items: center; flex-direction: column;">
                        <p>You're editing your dose window to ${startTimeFormatted} -> ${endTimeFormatted}. Click Confirm below if you'd like to save this change.</p>
                        <button id="confirmUpdateButton" onclick="confirmUpdateForDoseWindow(\'${startHour}\', \'${startMinute}\', \'${endHour}\', \'${endMinute}\', \'${doseWindowId}\')"
                            style="border-radius: 10px; padding: 10px; background-color: #002864; color: #FFF; border:0; font-size: 15px; font-family: Lora;">Confirm</button>
                    <div>
                `;
            }
            modal.style.display = 'block';
        }
        function confirmUpdateForDoseWindow(startHour, startMinute, endHour, endMinute, doseWindowId) {
            const initDetails = {
                ...postInitDetails,
                body: JSON.stringify({
                    startHour: parseInt(startHour),
                    startMinute: parseInt(startMinute),
                    endHour: parseInt(endHour),
                    endMinute: parseInt(endMinute),
                    doseWindowId: parseInt(doseWindowId)
                })
            };
            const confirmUpdateButton = document.getElementById("confirmUpdateButton");
            confirmUpdateButton.disabled = true;
            confirmUpdateButton.innerHTML = "Updating...";
            fetch(`${apiURL}/user/updateDoseWindow`, initDetails).then(() => {
                requestData();
                modalBody.innerHTML = "<p>Successfully updated!</p>";
            });
        }
        function startEditingDoseWindow(doseWindowId) {
            const startEditingButton = document.getElementById(`editDoseWindow-${doseWindowId}`);
            startEditingButton.innerHTML = "Cancel edits";
            startEditingButton.onclick = () => {stopEditingDoseWindow(doseWindowId)};
            const doseWindowHeader = document.getElementById(`doseWindowTimeHeader-${doseWindowId}`);
            doseWindowHeader.style.display = "none";
            const doseWindowEditingInterface = document.getElementById(`doseWindowEditingInterface-${doseWindowId}`);
            doseWindowEditingInterface.style.display = "flex";
        }
        function stopEditingDoseWindow(doseWindowId) {
            const stopEditingButton = document.getElementById(`editDoseWindow-${doseWindowId}`);
            stopEditingButton.innerHTML = "Edit";
            stopEditingButton.onclick = () => {startEditingDoseWindow(doseWindowId)};
            const doseWindowHeader = document.getElementById(`doseWindowTimeHeader-${doseWindowId}`);
            doseWindowHeader.style.display = "inline";
            const doseWindowEditingInterface = document.getElementById(`doseWindowEditingInterface-${doseWindowId}`);
            doseWindowEditingInterface.style.display = "none";
        }
        function renderAnalytics() {
            const timeOfDayOrder = ["morning", "afternoon", "evening"];
            let innerHTML = "<p style='color: #FFF'>Average dose time üïí</p>";
            for (const field of timeOfDayOrder) {
                if (field in adherenceHistory.averageDosingTime) {
                    const { hours, minutes, pm } = adherenceHistory.averageDosingTime[field];
                    let formattedMinutes = `${minutes}`;
                    if (formattedMinutes.length === 1) {
                        formattedMinutes = `0${formattedMinutes}`;
                    }
                    innerHTML += `<p style="color: #FFF; font-size: 12px;">${field} - ${hours}:${formattedMinutes} ${pm ? 'pm' : 'am'}</p>`;
                }
            }
            const analyticsDiv = document.getElementById("averageDoseTaken");
            analyticsDiv.innerHTML = innerHTML;
        }
        function renderBehaviorLearningChart() {
            if (chartLibraryLoaded) {
                if (activityAnalytics.behaviorLearningScores.length >= 2) {
                    let behaviorChartHeaderHTML = "<p style='color: #FFF'>AI learning progress üí°</p>";
                    const latestChange = activityAnalytics.behaviorLearningScores[activityAnalytics.behaviorLearningScores.length - 1][1] - activityAnalytics.behaviorLearningScores[activityAnalytics.behaviorLearningScores.length - 2][1];
                    behaviorChartHeaderHTML += `<p style='color: #FFF; font-size: 12px;'>Current learning score: <span style="font-size: 20px;">${activityAnalytics.behaviorLearningScores[activityAnalytics.behaviorLearningScores.length - 1][1]}</span></p>`;
                    behaviorChartHeaderHTML += `<p style='color: #FFF; font-size: 12px;'>Yesterday's score change: <span style="color:${latestChange > 0 ? '#09ad56' : '#f54242'}; font-size: 20px;">${latestChange > 0 ? "+" : ""}${latestChange}</span></p>`;
                    behaviorChartHeaderHTML += "<p style='color: #FFF; font-size: 12px;'>Your score improves when you consistently interact with us. Once you're at 100, I will be able to better understand when you're busy and free and give you texts at even better times.</p>";
                    document.getElementById("behaviorLearningChartTitle").innerHTML = behaviorChartHeaderHTML;
                    let dataArray = [["Day of Week", "Learning Score"], ...activityAnalytics.behaviorLearningScores]
                    var data = google.visualization.arrayToDataTable(dataArray);
                    var options = {
                        colors: ['white'],
                        fontName: 'Lora',
                        chartArea: {width: '80%', height: '80%'},
                        curveType: 'function',
                        legend: { position: "none"},
                        vAxis: {maxValue: 100, minValue: 0, textStyle: {color: "#FFF"}, gridlines: {color: "#AAA"}, minorGridlines: {color: "#AAA"}},
                        hAxis: {textStyle: {color: "#FFF"}, gridlines: {color: "#FFF"}},
                        backgroundColor: "#002864",
                        color: "FFF"
                    };

                    var chart = new google.visualization.LineChart(document.getElementById('behaviorLearningChart'));
                    chart.draw(data, options);
                }
            } else {
                google.charts.setOnLoadCallback(() => {
                    chartLibraryLoaded = true;
                    renderBehaviorLearningChart();
                });
            }
        }
        function getAverageDate(eventList) {
            let totalMinutes = 0;
            const filteredEventList = eventList.filter((event) => {return event.event_type === "take"});
            // no take events found, return null
            if (filteredEventList.length === 0) {
                return null;
            }
            for (const event of eventList) {
                if (event.event_type === "take") {
                    const dateObj = new Date(event.event_time)
                    totalMinutes += dateObj.getHours() * 60 + dateObj.getMinutes()
                }
            }
            totalMinutes /= filteredEventList.length;
            let hours = Math.floor(totalMinutes / 60);
            const minutes = Math.floor(totalMinutes % 60);
            let pm = false;
            if (hours > 12) {
                pm = true;
                hours -= 12;
            }
            // milliseconds /= eventList.length;
            // const averageDate = new Date(milliseconds);
            // console.log(averageDate);
            return { hours, minutes, pm }
        }
        // TODO: move this processing to the backend
        function processEventData(eventData) {
            const fieldsToSatisfy = Object.keys(eventData);
            let adherentDays = [];
            let adherentWithSkipDays = [];
            let missedDays = [];
            let insufficientDataDays = [];
            const takeHistoryByDay = {};
            const doseDataByTime = {}
            for (let dayOfMonth = 1; dayOfMonth <= 30; dayOfMonth++) {
                // 2AM - 2AM to account for night doses
                const startDate = new Date(2021, 3, dayOfMonth, 2, 0, 0, 0); // start time in GMT
                const endDate = new Date(2021, 3, dayOfMonth + 1, 2, 0, 0, 0); // end time in GMT
                const satisfiedFields = [];
                const skippedFields = [];
                const missedFields = [];
                takeHistoryByDay[dayOfMonth] = {}
                for (const field of fieldsToSatisfy) {
                    const eventDataForField = eventData[field];
                    for (const event of eventDataForField.events) {
                        const eventTimeObj = new Date(event.event_time);
                        if (eventTimeObj > startDate && eventTimeObj < endDate) {
                            if (event.event_type === "take") {
                                satisfiedFields.push(event);
                            } else if (event.event_type === "skip") {
                                skippedFields.push(event);
                            } else if (event.event_type === "boundary") {
                                missedFields.push(event);
                            }
                            takeHistoryByDay[dayOfMonth][field] = {"eventType": event.event_type, "eventTime": event.event_time};
                        }
                    }
                    if (!(field in doseDataByTime)) {
                        doseDataByTime[field] = eventData[field].dose;
                    }
                }
                if (satisfiedFields.length == fieldsToSatisfy.length) {
                    adherentDays.push(dayOfMonth);
                } else if (satisfiedFields.length + skippedFields.length == fieldsToSatisfy.length) {
                    adherentWithSkipDays.push(dayOfMonth);
                } else if (satisfiedFields.length + skippedFields.length + missedFields.length == fieldsToSatisfy.length) {
                    missedDays.push(dayOfMonth);
                } else {
                    insufficientDataDays.push(dayOfMonth);
                }
            }
            const averageDosingTime = {};
            for (const field in eventData) {
                const averageDate = getAverageDate(eventData[field].events);
                if (averageDate) {
                    averageDosingTime[field] = averageDate;
                }
            }
            return { adherentDays, adherentWithSkipDays, missedDays, insufficientDataDays, takeHistoryByDay, doseDataByTime, averageDosingTime };
        }
        function convertTZ(date, tzString) {
            return (typeof date === "string" ? new Date(date) : date).toLocaleString("en-US", {timeZone: tzString, hour: 'numeric', minute: 'numeric', hour12: true});
        }
        function getEventHTML(timeOfDayData) {
            const eventType = timeOfDayData.eventType;
            const eventTime = timeOfDayData.eventTime;
            if (eventType === "boundary") {
                return "<p class=missedDose>üõë Missed</p>";
            } else if (eventType === "take") {
                const eventTimeString = convertTZ(eventTime, "US/Pacific");
                return `<p class=takenDose>‚úÖ Taken at ${eventTimeString}</p>`;
            } else if (eventType === "skip") {
                return "<p class=skippedDose>üü† Skipped</p>";
            }
            return "";
        }
        function openTableDetails(dayOfMonth) {
            const dayOfMonthData = adherenceHistory.takeHistoryByDay[dayOfMonth];
            const modalTitle = document.getElementById("modalTitle");
            const modalBody = document.getElementById("modalBody");
            const timeOfDayCopyMap = {
                morning: "Morning dose",
                afternoon: "Afternoon dose",
                evening: "Evening dose"
            }
            modalTitle.innerHTML = `April ${dayOfMonth}`;
            modalBodyHTML = "";
            if (Object.keys(dayOfMonthData).length !== 0) {
                const timeOfDayOrder = ["morning", "afternoon", "evening"];
                for (let timeOfDay of timeOfDayOrder) {
                    if (timeOfDay in dayOfMonthData) {
                        const timeOfDayHTML = `<h3>${timeOfDayCopyMap[timeOfDay]}</h3>${adherenceHistory.doseDataByTime[timeOfDay].medication_name ? `<p>üíä<span style="font-size:15px">${adherenceHistory.doseDataByTime[timeOfDay].medication_name}</span></p>` : ""}${getEventHTML(dayOfMonthData[timeOfDay])}`;
                        modalBodyHTML += timeOfDayHTML;
                    }
                }
                modalBody.innerHTML = modalBodyHTML;
            } else {
                modalBody.innerHTML = "<p>No dose data for this day.</p>";
            }
            modal.style.display = "block";
        }
        function generateCalendar() {
            var htmlBlob = `
            <thead>
                <tr>
                    <th>Sun</th>
                    <th>Mon</th>
                    <th>Tue</th>
                    <th>Wed</th>
                    <th>Thu</th>
                    <th>Fri</th>
                    <th>Sat</th>
                </tr>
                </thead>
                <tbody>
            `;
            const dates = [
                ["*28", "*29", "*30", "*31", "1", "2", "3"],
                ["4", "5", "6", "7", "8", "9", "10"],
                ["11", "12", "13", "14", "15", "16", "17"],
                ["18", "19", "20", "21", "22", "23", "24"],
                ["25", "26", "27", "28", "29", "30", "*1"],
            ]
            const currentDate = new Date();
            const currentDayOfMonth = currentDate.getDate();
            for (const dateRow of dates) {
                htmlBlob += "<tr>";
                for (const date of dateRow) {
                    var faded = false;
                    var processedDate = date;
                    var adherenceClass = "noAdherenceData";
                    const dayOfMonth = parseInt(processedDate);
                    if (adherenceHistory.adherentDays.includes(dayOfMonth)) {
                        adherenceClass = "adherent";
                    } else if (adherenceHistory.missedDays.includes(dayOfMonth)) {
                        adherenceClass = "nonadherent";
                    } else if (adherenceHistory.adherentWithSkipDays.includes(dayOfMonth)) {
                        adherenceClass = "adherentWithSkip";
                    }
                    if (dayOfMonth === currentDayOfMonth) {
                        adherenceClass += " currentDate";
                    }
                    if (date.includes("*")) {
                        faded = true;
                        processedDate = date.slice(1);
                    }
                    const onClickCall = faded ? "" : ` onclick=openTableDetails(${processedDate})`;
                    htmlBlob += `<td class='${faded ? "fadedDate " : ""}${adherenceClass}'${onClickCall}>${processedDate}</td>`;
                }
                htmlBlob += "</tr>";
            }
            htmlBlob += `
                </tbody>
                </tr>
            `;
            calendar.innerHTML = htmlBlob;
        }
        function renderServicePaused() {
            statusIndicator.innerHTML = servicePaused ? "paused üö´" : "active ‚úÖ";
            pauseButton.innerHTML = servicePaused ? "Resume" : "Pause";
            pauseButton.setAttribute("onclick", servicePaused ? "resumeService()" : "pauseService()");
            pauseButton.style.backgroundColor = servicePaused ? "#09ad56" : "transparent";
            pauseButton.style.color = servicePaused ? "FFF": "#f54242";
            pauseButton.style.paddingTop = servicePaused ? "15px" : "0px";
            pauseButton.style.paddingBottom = servicePaused ? "15px" : "0px";
            pauseButton.style.fontSize = servicePaused ? "20px": "15px";
            pauseStatusExplainer.innerHTML = servicePaused ? "I'm currently paused and am not texting you about your medication. You can still tell me when you've taken or skipped a dose." : "I'm currently texting you to help you stay on track with your medication.";
            pauseStatusExplainer.style.color = servicePaused ? "#f54242" : "#OOO";
            buttonActionExplainer.innerHTML = servicePaused ? "Resuming allows me to text you and help you stay on track with your medication." : "Pausing will still allow you to tell us when you've taken or skipped a medication, but we will no longer remind you to take it.";
        }
        function enterPhoneNumber() {
            const initDetails = {...postInitDetails, body: JSON.stringify({phoneNumber: phoneNumberEntry.value})}
            fetch(`${apiURL}/login/requestCode`, initDetails).then((response) => {
                if (response.status === 200) {
                    const phoneEntryBox = document.getElementById("loginBox");
                    const codeEntryBox = document.getElementById("loginBox2");
                    phoneEntryBox.style.display = "none";
                    codeEntryBox.style.display = "flex";
                } else {
                    phoneNumberEntryInstructions.innerHTML = "We couldn't find your phone number in our records. Please make sure you've entered it correctly and try again.";
                }
            });
        }
        function login() {
            const codeEntry = document.getElementById("secretCodeEntry");
            const initDetails = {...postInitDetails, body: JSON.stringify({phoneNumber: phoneNumberEntry.value, code: codeEntry.value})}
            fetch(`${apiURL}/login`, initDetails).then((response) => {
                if (response.status === 200) {
                    requestData();
                } else {
                    codeEntryInstructions.innerHTML = "Secret code was incorrect. Double check to make sure you've entered it correctly.";
                }

            });
        }
        function logout() {
            fetch(`${apiURL}/logout`, getInitDetails).then(() => {
                requestData();
            })
        }
        function pauseService() {
            pauseButton.innerHTML = "Loading...";
            pauseButton.onclick = "";
            const initDetails = {...postInitDetails}
            fetch(`${apiURL}/user/pause`, postInitDetails).then(() => {
                requestData();
            });
        }
        function resumeService() {
            pauseButton.innerHTML = "Loading...";
            pauseButton.onclick = "";
            const initDetails = {...postInitDetails}
            fetch(`${apiURL}/user/resume`, postInitDetails).then(() => {
                requestData();
            });
        }
        requestData();
    </script>
</body>