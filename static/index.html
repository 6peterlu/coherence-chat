<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="static/css/styles.css">
</head>
<body>
    <input id="phoneNumberEntry" placeholder="Phone number"/>
    <button id="login" onclick="login()" style="display:none">Login</button>
    <div id="trackingDisplay">
        <h2 id="welcomeHeader">Welcome!</h2>
        <h3>Today's doses</h3>
        <h4 id="takeNow">Take now</h4>
        <div id="takeNowBody"></div>
        <h4 id="takeLater">Take later</h4>
        <div id="takeLaterBody"></div>
        <h3>Dose history</h3>
        <div>
            <table class="blueTable" id="calendar">
                <!-- <thead>
                <tr>
                    <th>Sun</th>
                    <th>Mon</th>
                    <th>Tues</th>
                    <th>Wed</th>
                    <th>Thurs</th>
                    <th>Fri</th>
                    <th>Sat</th>
                </tr>
                </thead>
                <tbody>
                <tr>
                <td></td><td>1</td><td>2</td><td>3</td><td>4</td><td>5</td><td>6</td></tr>
                <tr>
                <td>7</td><td>8</td><td>9</td><td>10</td><td>11</td><td>cell6_2</td><td>cell7_2</td></tr>
                <tr>
                <td>cell1_3</td><td>cell2_3</td><td>cell3_3</td><td>cell4_3</td><td>cell5_3</td><td>cell6_3</td><td>cell7_3</td></tr>
                <tr>
                <td>cell1_4</td><td>cell2_4</td><td>cell3_4</td><td>cell4_4</td><td>cell5_4</td><td>cell6_4</td><td>cell7_4</td></tr>
                </tbody>
                </tr> -->
            </table>
        </div>
    </div>
    <script defer>
        var runningLocally = true;  // if this is false, you're editing PROD.
        var apiURL = runningLocally ? "http://localhost:5000" : "https://coherence-chat.herokuapp.com";
        const tracking = document.getElementById("trackingDisplay");
        const phoneNumberEntry = document.getElementById("phoneNumberEntry");
        const loginButton = document.getElementById("login");
        const welcomeHeader = document.getElementById("welcomeHeader");
        const takeNowBody = document.getElementById("takeNowBody");
        const takeLaterBody = document.getElementById("takeLaterBody");
        const calendar = document.getElementById("calendar");
        const getInitDetails = {
            method: 'get',
            headers: {
                "Access-Control-Allow-Origin": "*",
                "Access-Control-Allow_Methods": "GET",
                "Access-Control_Allow_Headers": "*",
                "Cache-Control": "no-cache"
            },
            mode: "cors"
        };
        const postInitDetails = {
            method: 'post',
            headers: {
                "Access-Control-Allow-Origin": "*",
                "Access-Control-Allow_Methods": "POST",
                "Access-Control_Allow_Headers": "*",
                "Content-Type": "application/json; charset=utf-8",
                "Cache-Control": "no-cache"
            },
            mode: "cors",
        };
        function requestData() {
            fetch(`${apiURL}/patientData`, getInitDetails).then(response => response.json()).then(result => {
                console.log(result);
                if (!result.phoneNumber) {
                    phoneNumberDisplay.innerHTML = "you need to login";
                    phoneNumberEntry.style.display = "block";
                    loginButton.style.display = "block";

                } else {
                    welcomeHeader.innerHTML = `Welcome, ${result.phoneNumber}!`;

                    phoneNumberEntry.style.display = "none";
                    loginButton.style.display = "none";
                }
            });
        }
        function generateCalendar() {
            var htmlBlob = `
            <thead>
                <tr>
                    <th>Sun</th>
                    <th>Mon</th>
                    <th>Tues</th>
                    <th>Wed</th>
                    <th>Thurs</th>
                    <th>Fri</th>
                    <th>Sat</th>
                </tr>
                </thead>
                <tbody>
            `;
            const dates = [
                ["*28", "*29", "*30", "*31", "1", "2", "3"],
                ["4", "5", "6", "7", "8", "9", "10"],
                ["11", "12", "13", "14", "15", "16", "17"],
                ["18", "19", "20", "21", "22", "23", "24"],
                ["25", "26", "27", "28", "29", "30", "*1"],
            ]
            for (const dateRow of dates) {
                htmlBlob += "<tr>";
                for (const date of dateRow) {
                    var faded = false;
                    var processedDate = date;
                    if (date.includes("*")) {
                        faded = true;
                        processedDate = date.slice(1);
                    }
                    htmlBlob += `<td class=${faded ? "fadedDate" : ""}>${processedDate}</td>`;
                }
                htmlBlob += "</tr>";
            }
            htmlBlob += `
                </tbody>
                </tr>
            `;
            calendar.innerHTML = htmlBlob;

        }
        function login() {
            const initDetails = {...postInitDetails, body: JSON.stringify({phoneNumber: phoneNumberEntry.value})}
            fetch(`${apiURL}/login`, initDetails).then(() => {requestData()});
        }
        requestData();
        generateCalendar();
    </script>
</body>