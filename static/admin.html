<head>
</head>
<body>
    <h1 id="header"></h1>
    <input id="password" placeholder="admin password"/>
    <button id="switchEnv" onclick="switchEnv()">Switch environment</button>
    <div>
        <h2 id="onlineStatus" style="display:inline"></h2>
        <button id="onlineToggle" onclick="onlineToggle()"></button>
    </div>
    <button id="getJobs" onclick="retrieveJobs()">Refresh</button>
    <button id="getBasicInfo" onclick="getBasicInfo()">Test connection</button>
    <div>
        <input id="phoneNumberEntry" type="tel" placeholder="phone"/>
        <input id="medicationNameEntry" type="text" placeholder="medication name"/>
        <input id="patientNameEntry" type="text" placeholder = "patient name"/>
        <input id="startTimeEntry" type="time"/>
        <input id="endTimeEntry" type="time"/>
        <button id="createJob" onclick="createJob()">Create job</button>
    </div>
    <div>
        <input id="doseId" type="number" placeholder="dose id"/>
        <select name="reminderType" id="reminderType">
            <option value="absent">absent</option>
            <option value="followup">followup</option>
            <option value="initial">initial</option>
        </select>
        <button id="sendManual" onclick="sendManual()">Send manual</button>
    </div>

    <p>Job list:</p>
    <div class="jobList"></div>
    <p>Dose list:</p>
    <div class="doseList"></div>
    <p>Reminder list:</p>
    <div class="reminderList" style="overflow: scroll; max-height: 500px;"></div>
    <div class="manualChat">
        <input id="messageSearchPhoneNumber" type="number" placeholder="phone number"/>
        <input id="daysToPull" type="number" placeholder="days to pull"/>
        <button id="searchForConversation" onclick="searchForConversation()">Retrieve conversation</button>
        <button id="getEventsForPhoneNumber" onclick="getEventsForPhoneNumber()">Retrieve events</button>
        <button id="manuallyTakeover" style="visibility:hidden" onclick="manualTakeover()">Manually takeover</button>
        <p id="takeoverList" style="visibility:hidden"></p>
        <div id="customChat" style="visibility:hidden">
            <textarea id="customTextMessage" placeholder="custom text message"></textarea>
            <button id="searchForConversation" onclick="sendCustomText()">Send custom text</button>
        </div>
        <div id="addEventDiv">
            <input id="eventDoseId" type="number" placeholder="dose id"/>
            <input id="eventTime" type="datetime-local" />
            <select name="eventType" id="eventType">
                <option value="take">take</option>
                <option value="skip">skip</option>
            </select>
            <button id="addEventButton" onclick="addEvent()">Manually add event</button>
        </div>
    </div>
    <div class="messageList"></div>
    <script defer>
        const jobListDiv = document.querySelector('.jobList');
        const doseListDiv = document.querySelector('.doseList');
        const reminderListDiv = document.querySelector('.reminderList');
        const messageListDiv = document.querySelector('.messageList');
        const headerText = document.getElementById("header");
        var editingDoses = [];
        var runningLocally = true;  // if this is false, you're editing PROD.
        var adminData = {};  // all data being rendered in admin panel
        headerText.innerHTML = `current env: ${runningLocally ? "local" : "PRODUCTION"}`;
        var apiURL = runningLocally ? "http://localhost:5000" : "https://coherence-chat.herokuapp.com";
        const initDetails = {
            method: 'get',
            headers: {
                "Access-Control-Allow-Origin": "*",
                "Access-Control-Allow_Methods": "GET",
                "Access-Control_Allow_Headers": "*",
                "Cache-Control": "no-cache"
            },
            mode: "cors"
        };

        // HTTP helpers
        async function get(route, queryArgs) {
            const password = document.getElementById("password").value;
            const queryArgsList = [];
            const updatedQueryArgs = {...queryArgs, pw: password};
            for (const arg in updatedQueryArgs) {
                queryArgsList.push(`${arg}=${updatedQueryArgs[arg]}`);
            }
            const queryString = queryArgsList.length > 0 ? `?${queryArgsList.join("&")}` : "";
            return await fetch(`${apiURL}/${route}${queryString}`, initDetails);
        }

        async function post(route, body) {
            const password = document.getElementById("password").value;
            const bodyWithPassword = {...body, pw: password};
            const initDetails = {
                method: 'post',
                headers: {
                    "Access-Control-Allow-Origin": "*",
                    "Access-Control-Allow_Methods": "POST",
                    "Access-Control_Allow_Headers": "*",
                    "Content-Type": "application/json; charset=utf-8",
                    "Cache-Control": "no-cache"
                },
                mode: "cors",
                body: JSON.stringify(bodyWithPassword)
            };
            return await fetch(`${apiURL}/${route}`, initDetails);
        }


        // patch causes 400 on heroku for now, and I don't think it's that important yet
        // just use post
        // async function patch(route, body) {
        //     const password = document.getElementById("password").value;
        //     const bodyWithPassword = {...body, pw: password};
        //     const initDetails = {
        //         method: 'patch',
        //         headers: {
        //             "Access-Control-Allow-Origin": "*",
        //             "Access-Control-Allow_Methods": "PATCH",
        //             "Access-Control_Allow_Headers": "*",
        //             "Content-Type": "application/json; charset=utf-8",
        //             "Cache-Control": "no-cache"
        //         },
        //         mode: "cors",
        //         body: JSON.stringify(bodyWithPassword)
        //     };
        //     return await fetch(`${apiURL}/${route}`, initDetails);
        // }

        // we can't use delete, its reserved.
        async function httpDelete(route, body) {
            const password = document.getElementById("password").value;
            const bodyWithPassword = {...body, pw: password};
            const initDetails = {
                method: 'delete',
                headers: {
                    "Access-Control-Allow-Origin": "*",
                    "Access-Control-Allow_Methods": "DELETE",
                    "Access-Control_Allow_Headers": "*",
                    "Content-Type": "application/json; charset=utf-8",
                    "Cache-Control": "no-cache"
                },
                mode: "cors",
                body: JSON.stringify(bodyWithPassword)
            };
            return await fetch(`${apiURL}/${route}`, initDetails);
        }

        function sendCustomText() {
            const phoneNumber = document.getElementById("messageSearchPhoneNumber").value;
            const text = document.getElementById("customTextMessage").value;
            const body = { phoneNumber, text };
            post("manual/text", body);
        }
        async function manualTakeover() {
            await retrieveJobs();
            const phoneNumber = document.getElementById("messageSearchPhoneNumber").value;
            const uri = `${apiURL}/manual/takeover`;
            const body = { phoneNumber };
            if (adminData.manualTakeover.includes(`+11${phoneNumber}`)) {
                httpDelete("manual/takeover", { phoneNumber }).then(response => response.json()).then(result => {
                    retrieveJobs();
                });
            } else {
                post("manual/takeover", { phoneNumber }).then(response => response.json()).then(result => {
                    retrieveJobs();
                });
            }
        }
        function searchForConversation() {
            const phoneNumber = document.getElementById("messageSearchPhoneNumber").value;
            const days = document.getElementById("daysToPull").value;
            get("messages", { phoneNumber, days }).then(response => response.json()).then(result => {
                renderMessages(result);
            });
        }
        function renderMessages(messagesList) {
            const rows = messagesList.map(message => {
                return `
                    <li>
                        <p style="color:${message.sender === 'them' ? 'blue' : 'black'}">${message.date_sent}/${message.sender}: ${message.body}</p>
                    </li>
                `
            });
            const html = `<ul>${rows.join("")}</ul>`;
            messageListDiv.innerHTML = html;
        }
        function switchEnv() {
            runningLocally = !runningLocally;
            headerText.innerHTML = `current env: ${runningLocally ? "local" : "PRODUCTION"}`;
            apiURL = runningLocally ? "http://localhost:5000" : "https://coherence-chat.herokuapp.com";
            messageListDiv.innerHTML = "";
            retrieveJobs();
        }
        function convertTZ(date, tzString) {
            return new Date((typeof date === "string" ? new Date(date) : date).toLocaleString("en-US", {timeZone: tzString}));
        }
        function renderJobs() {
            const jobComparator = (job1, job2) => {
                if (job1.name > job2.name) {
                    return 1;
                }
                if (job2.name > job1.name) {
                    return -1;
                }
                return 0;
            }
            const sortedJobList = adminData.jobs.sort(jobComparator);
            const rows = sortedJobList.map(job => {
                if (job.trigger === "interval") {
                    return `
                        <li>
                            <p style="display:inline">${job.name}:${job.trigger}:${convertTZ(job.start_date, "US/Pacific")}</p>
                            <button onclick="deleteJob(\'${job.id}\')">delete job</button>
                        </li>
                    `
                } else {
                    return `
                        <li>
                            <p style="display:inline">${job.name}:${job.trigger}:${convertTZ(job.run_date)}</p>
                            <button onclick="deleteJob(\'${job.id}\')">delete job</button>
                        </li>
                    `
                }
            });
            const html = `<ul>${rows.join("")}</ul>`;
            jobListDiv.innerHTML = html;
        }
        function convertToPT(hour) {
            let convertedHour = hour - 7;
            if (convertedHour < 0) {
                convertedHour += 24;
            }
            return convertedHour;
        }
        function convertToUTC(hour) {
            return (hour + 7) % 24;
        }
        function renderDoses() {
            const rows = adminData.doses.map(dose => {
                const startHour = dose.start_hour;
                return `
                    <li>
                        <p style="display:inline; color:${dose.active ? '#000' : '#AAA'}">${dose.id}-${dose.medication_name ? dose.medication_name : "No name provided"}, ${dose.patient_name}/${dose.phone_number}, ${convertToPT(dose.start_hour)}:${dose.start_minute}->${convertToPT(dose.end_hour)}:${dose.end_minute}</p>
                        ${editingDoses.includes(dose.id) ? `<input id="dosename-${dose.id}" placeholder='medication name' value='${dose.medication_name}'/><button onclick=saveDoseEdits(\'${dose.id}\')>Save edits</button><button onclick=toggleDoseEditing(${dose.id})>Stop editing</button>`: `<button onclick="toggleDoseEditing(${dose.id})">edit dose</button>`}
                        <button onclick="toggleActivateDose(\'${dose.id}\'')">activate/deactivate dose</button>
                        <button onclick="deleteDose(\'${dose.id}\')">delete dose</button>
                    </li>
                `
            });
            const html = `<ul>${rows.join("")}</ul>`;
            doseListDiv.innerHTML = html;
        }
        function renderReminders() {
            const rows = adminData.reminders.map(reminder => {
                return `
                    <li>
                        <p style="display:inline">${reminder.reminder_type}-${reminder.dose_id}-${convertTZ(reminder.send_time, "US/Pacific")}</p>
                        <button onclick="deleteReminder(\'${reminder.id}\')">delete reminder record</button>
                    </li>
                `
            });
            const html = `<ul>${rows.join("")}</ul>`;
            reminderListDiv.innerHTML = html;
        }
        function renderEvents(eventList) {
            const rows = eventList.events.map(event => {
                return `
                    <li>
                        <p style="display:inline">${event.phone_number}|${convertTZ(event.event_time, "US/Pacific")}, ${event.event_type}: ${event.description}</p>
                        <button onclick="deleteEvent(\'${event.id}\')">delete event record</button>
                    </li>
                `;
            })
            const html = `<ul>${rows.join("")}</ul>`;
            messageListDiv.innerHTML = html;
        }
        function getBasicInfo() {
            get("scheduler", {}).then(result => {
                console.log("getting basic info");
                console.log(result);
            });
        }
        function renderOnlineStatus() {
            const onlineStatusText = document.getElementById("onlineStatus");
            const onlineButtonToggle = document.getElementById("onlineToggle");
            onlineStatusText.innerHTML = `You're currently ${adminData.onlineStatus ? "online" : "offline"}.`;
            onlineButtonToggle.innerHTML = `Go ${adminData.onlineStatus ? "offline" : "online"}`;
            const customChat = document.getElementById("customChat");
            customChat.style.visibility = adminData.onlineStatus ? "visible" : "hidden";
            const manualTakeover = document.getElementById("manuallyTakeover");
            manualTakeover.style.visibility = adminData.onlineStatus ? "visible" : "hidden";
            const manualTakeoverList = document.getElementById("takeoverList");
            manualTakeoverList.style.visibility = adminData.onlineStatus ? "visible" : "hidden";
            manualTakeoverList.innerHTML = adminData.manualTakeover;
        }
        function onlineToggle() {
            post("online", {}).then(
                response => response.json()).then(result => {
                    retrieveJobs();
                }
            );
        }
        function toggleActivateDose(doseId) {
            post("dose/toggleActivate", { doseId }).then(() => {
                retrieveJobs();
            });
        }

        function toggleDoseEditing(doseId) {
            if (editingDoses.includes(doseId)) {
                editingDoses = editingDoses.filter((dose) => {return dose !== doseId});
            } else {
                editingDoses.push(doseId);
            }
            renderDoses();
        }
        function saveDoseEdits(doseId) {
            const updatedName = document.getElementById(`dosename-${doseId}`).value;
            post("dose/editName", {doseName: updatedName, doseId})
            toggleDoseEditing(parseInt(doseId));
            retrieveJobs();
        }
        function addEvent() {
            const phoneNumber = document.getElementById("messageSearchPhoneNumber").value;
            const eventType = document.getElementById("eventType").value;
            const doseId = document.getElementById("eventDoseId").value;
            const eventTime = document.getElementById("eventTime").value;
            post("events", { phoneNumber, eventType, doseId, eventTime }).then(
                response => response.json()).then(result => {
                    getEventsForPhoneNumber();
                }
            );
        }
        async function retrieveJobs() {
            await get("scheduler/jobs", {}).then(response => response.json()).then(result => {
                adminData.jobs = result;
                renderJobs();
            })
            await get("everything", {}).then(response => response.json()).then(result => {
                adminData = {...adminData, ...result}
                doseList = result.doses;
                renderDoses();
                renderReminders();
                renderOnlineStatus();
            })
        }
        function getEventsForPhoneNumber() {
            const phoneNumber = document.getElementById("messageSearchPhoneNumber").value;
            const days = document.getElementById("daysToPull").value;
            get("events", { phoneNumber, days }).then(response => response.json()).then(result => {
                renderEvents(result);
            });
        }
        // helper fn to get next alarm datetime from FE, not currently in use
        // function getAlarmStartTime(hour, minute) {
        //     var alarmTime  = new Date();
        //     const currentHour = alarmTime.getHours();
        //     const currentMinute = alarmTime.getMinutes();
        //     if (currentHour > hour || (currentHour == hour && currentMinute > minute)) {
        //         alarmTime.setDate(alarmTime.getDate() + 1);
        //     }
        //     alarmTime.setHours(hour);
        //     alarmTime.setMinutes(minute);
        //     alarmTime.setSeconds(0);
        //     alarmTime.setMilliseconds(0);
        //     const dateString = `${alarmTime.getFullYear()}-${alarmTime.getMonth() + 1}-${alarmTime.getDate()} ${alarmTime.getHours()}:${alarmTime.getMinutes()}:${alarmTime.getSeconds()}`;
        //     return dateString;
        // }
        function sendManual() {
            const reminderType = document.getElementById("reminderType").value;
            const doseId = document.getElementById("doseId").value;
            const body = { reminderType, doseId }
            post("manual", { reminderType, doseId }).then(
                response => response.json()).then(result => {
                    retrieveJobs();
                }
            );
        }
        function createJob() {
            const startTime = document.getElementById("startTimeEntry").value;
            const splitStartTime = startTime.split(":");
            const startHour = convertToUTC(parseInt(splitStartTime[0]));
            const startMinute = parseInt(splitStartTime[1]);
            const endTime = document.getElementById("endTimeEntry").value;
            const splitEndTime = endTime.split(":");
            const endHour = convertToUTC(parseInt(splitEndTime[0]));
            const endMinute = parseInt(splitEndTime[1]);
            const phoneNumber = `1${document.getElementById("phoneNumberEntry").value}`;
            const patientName = document.getElementById("patientNameEntry").value;
            const medicationName = document.getElementById("medicationNameEntry").value;

            const uri = `${apiURL}/dose`;
            const body = {
                startHour,
                startMinute,
                endHour,
                endMinute,
                phoneNumber,
                medicationName,
                patientName
            };
            post("dose", body).then(
                response => response.json()).then(result => {
                    retrieveJobs();
                }
            );
        }
        function deleteJob(id) {
            httpDelete(`scheduler/jobs/${id}`, {}).then(() => {
                retrieveJobs();
            })
        }
        function deleteDose(id) {
            httpDelete("dose", { id }).then(() => {
                retrieveJobs();
            });
        }
        function deleteReminder(id) {
            httpDelete("reminder", { id }).then(() => {
                retrieveJobs();
            });
        }
        function deleteEvent(id) {
            httpDelete("events", { id }).then(() => {
                getEventsForPhoneNumber();
            });
        }
        retrieveJobs();
    </script>
</body>