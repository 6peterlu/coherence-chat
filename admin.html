<head>
</head>
<body>
    <h1 id="header"></h1>
    <button id="switchEnv" onclick="switchEnv()">Switch environment</button>
    <div>
        <h2 id="onlineStatus" style="display:inline"></h2>
        <button id="onlineToggle" onclick="onlineToggle()"></button>
    </div>
    <button id="getJobs" onclick="retrieveJobs()">Refresh</button>
    <button id="getBasicInfo" onclick="getBasicInfo()">Test connection</button>
    <div>
        <input id="phoneNumberEntry" type="tel" placeholder="phone"/>
        <input id="medicationNameEntry" type="text" placeholder="medication name"/>
        <input id="patientNameEntry" type="text" placeholder = "patient name"/>
        <input id="startTimeEntry" type="time"/>
        <input id="endTimeEntry" type="time"/>
        <button id="createJob" onclick="createJob()">Create job</button>
    </div>
    <div>
        <input id="doseId" type="number" placeholder="dose id"/>
        <select name="reminderType" id="reminderType">
            <option value="absent">absent</option>
            <option value="followup">followup</option>
            <option value="initial">initial</option>
        </select>
        <button id="sendManual" onclick="sendManual()">Send manual</button>
    </div>

    <p>Job list:</p>
    <div class="jobList"></div>
    <p>Dose list:</p>
    <div class="doseList"></div>
    <p>Reminder list:</p>
    <div class="reminderList" style="overflow: scroll; max-height: 500px;"></div>
    <div class="manualChat">
        <input id="messageSearchPhoneNumber" type="number" placeholder="phone number"/>
        <input id="daysToPull" type="number" placeholder="days to pull"/>
        <button id="searchForConversation" onclick="searchForConversation()">Retrieve conversation</button>
        <button id="getEventsForPhoneNumber" onclick="getEventsForPhoneNumber()">Retrieve events</button>
        <button id="manuallyTakeover" style="visibility:hidden" onclick="manualTakeover()">Manually takeover</button>
        <p id="takeoverList" style="visibility:hidden"></p>
        <div id="customChat" style="visibility:hidden">
            <textarea id="customTextMessage" placeholder="custom text message"></textarea>
            <button id="searchForConversation" onclick="sendCustomText()">Send custom text</button>
        </div>
    </div>
    <div class="messageList"></div>
    <script defer>
        const jobListDiv = document.querySelector('.jobList');
        const doseListDiv = document.querySelector('.doseList');
        const reminderListDiv = document.querySelector('.reminderList');
        const messageListDiv = document.querySelector('.messageList');
        const headerText = document.getElementById("header");
        var runningLocally = true;  // if this is false, you're editing PROD.
        var manualTakeoverList = [];  // list of numbers that are taken over
        headerText.innerHTML = `current env: ${runningLocally ? "local" : "PRODUCTION"}`;
        var apiURL = runningLocally ? "http://localhost:5000" : "https://coherence-chat.herokuapp.com";

        function sendCustomText() {
            const phoneNumber = document.getElementById("messageSearchPhoneNumber").value;
            const text = document.getElementById("customTextMessage").value;
            const body = { phoneNumber, text };
            const uri = `${apiURL}/manual/text`;
            const initDetails = {
                method: 'post',
                headers: {
                    "Access-Control-Allow-Origin": "*",
                    "Access-Control-Allow_Methods": "POST",
                    "Access-Control_Allow_Headers": "*",
                    "Content-Type": "application/json; charset=utf-8",
                    "Cache-Control": "no-cache"
                },
                mode: "cors",
                body: JSON.stringify(body)
            };
            fetch(uri, initDetails);
        }
        async function manualTakeover() {
            await retrieveJobs();
            const phoneNumber = document.getElementById("messageSearchPhoneNumber").value;
            const uri = `${apiURL}/manual/takeover`;
            const body = { phoneNumber };
            var initDetails = {};
            if (manualTakeoverList.includes(`+11${phoneNumber}`)) {
                console.log("deleting")
                initDetails = {
                    method: 'delete',
                    headers: {
                        "Access-Control-Allow-Origin": "*",
                        "Access-Control-Allow_Methods": "DELETE",
                        "Access-Control_Allow_Headers": "*",
                        "Content-Type": "application/json; charset=utf-8",
                        "Cache-Control": "no-cache"
                    },
                    mode: "cors",
                    body: JSON.stringify(body)
                };
            } else {
                initDetails = {
                    method: 'post',
                    headers: {
                        "Access-Control-Allow-Origin": "*",
                        "Access-Control-Allow_Methods": "POST",
                        "Access-Control_Allow_Headers": "*",
                        "Content-Type": "application/json; charset=utf-8",
                        "Cache-Control": "no-cache"
                    },
                    mode: "cors",
                    body: JSON.stringify(body)
                };
            }
            await fetch(uri, initDetails).then(response => response.json()).then(result => {
                retrieveJobs();
            });
        }
        function searchForConversation() {
            const phoneNumber = document.getElementById("messageSearchPhoneNumber").value;
            const days = document.getElementById("daysToPull").value;
            const uri = `${apiURL}/messages?phoneNumber=${phoneNumber}&days=${days}`;
            const initDetails = {
                method: 'get',
                headers: {
                    "Access-Control-Allow-Origin": "*",
                    "Access-Control-Allow_Methods": "GET",
                    "Access-Control_Allow_Headers": "*",
                    "Cache-Control": "no-cache"
                },
                mode: "cors"
            };
            fetch(uri, initDetails).then(response => response.json()).then(result => {
                console.log("pulling conversation");
                renderMessages(result);
            });
        }
        function renderMessages(messagesList) {
            const rows = messagesList.map(message => {
                return `
                    <li>
                        <p style="color:${message.sender === 'them' ? 'blue' : 'black'}">${message.date_sent}/${message.sender}: ${message.body}</p>
                    </li>
                `
            });
            const html = `<ul>${rows.join("")}</ul>`;
            messageListDiv.innerHTML = html;
        }
        function switchEnv() {
            runningLocally = !runningLocally;
            headerText.innerHTML = `current env: ${runningLocally ? "local" : "PRODUCTION"}`;
            apiURL = runningLocally ? "http://localhost:5000" : "https://coherence-chat.herokuapp.com";
            messageListDiv.innerHTML = "";
            retrieveJobs();
        }
        function convertTZ(date, tzString) {
            return new Date((typeof date === "string" ? new Date(date) : date).toLocaleString("en-US", {timeZone: tzString}));
        }
        function renderJobs(jobList) {
            const rows = jobList.map(job => {
                if (job.trigger === "interval") {
                    return `
                        <li>
                            <p style="display:inline">${job.name}:${job.trigger}:${convertTZ(job.start_date, "US/Pacific")}</p>
                            <button onclick="deleteJob(\'${job.id}\')">delete job</button>
                        </li>
                    `
                } else {
                    return `
                        <li>
                            <p style="display:inline">${job.name}:${job.trigger}:${convertTZ(job.run_date)}</p>
                            <button onclick="deleteJob(\'${job.id}\')">delete job</button>
                        </li>
                    `
                }
            });
            const html = `<ul>${rows.join("")}</ul>`;
            jobListDiv.innerHTML = html;
        }
        function convertToPT(hour) {
            if (runningLocally) {
                return hour;
            }
            let convertedHour = hour - 7;
            if (convertedHour < 0) {
                convertedHour += 24;
            }
            return convertedHour;
        }
        function convertToUTC(hour) {
            if (runningLocally) {
                return hour;
            }
            return (hour + 7) % 24;
        }
        function renderDoses(doseList) {
            const rows = doseList.map(dose => {
                const startHour = dose.start_hour;
                return `
                    <li>
                        <p style="display:inline">${dose.id}-${dose.medication_name}, ${dose.patient_name}/${dose.phone_number}, ${convertToPT(dose.start_hour)}:${dose.start_minute}->${convertToPT(dose.end_hour)}:${dose.end_minute}</p>
                        <button onclick="deleteDose(\'${dose.id}\')">delete dose</button>
                    </li>
                `
            });
            const html = `<ul>${rows.join("")}</ul>`;
            doseListDiv.innerHTML = html;
        }
        function renderReminders(reminderList) {
            const rows = reminderList.map(reminder => {
                return `
                    <li>
                        <p style="display:inline">${reminder.reminder_type}-${reminder.dose_id}-${convertTZ(reminder.send_time, "US/Pacific")}</p>
                        <button onclick="deleteReminder(\'${reminder.id}\')">delete reminder record</button>
                    </li>
                `
            });
            const html = `<ul>${rows.join("")}</ul>`;
            reminderListDiv.innerHTML = html;
        }
        function renderEvents(eventList) {
            const rows = eventList.events.map(event => {
                return `
                    <li>
                        <p style="display:inline">${event.phone_number}|${convertTZ(event.event_time, "US/Pacific")}, ${event.event_type}: ${event.description}</p>
                        <button onclick="deleteEvent(\'${event.id}\')">delete event record</button>
                    </li>
                `;
            })
            const html = `<ul>${rows.join("")}</ul>`;
            messageListDiv.innerHTML = html;
        }
        function getBasicInfo() {
            const uri = `${apiURL}/scheduler`;
            const initDetails = {
                method: 'get',
                headers: {
                    "Access-Control-Allow-Origin": "*",
                    "Access-Control-Allow_Methods": "GET",
                    "Access-Control_Allow_Headers": "*",
                    "Content-Type": "application/json; charset=utf-8",
                    "Cache-Control": "no-cache"
                },
                mode: "cors"
            };
            fetch(uri, initDetails).then(response => response.json()).then(result => {
                console.log("getting basic info");
                console.log(result);
            });
        }
        function renderOnlineStatus(onlineStatus, manualTakeoverData) {
            const onlineStatusText = document.getElementById("onlineStatus");
            const onlineButtonToggle = document.getElementById("onlineToggle");
            onlineStatusText.innerHTML = `You're currently ${onlineStatus ? "online" : "offline"}.`;
            onlineButtonToggle.innerHTML = `Go ${onlineStatus ? "offline" : "online"}`;
            const customChat = document.getElementById("customChat");
            customChat.style.visibility = onlineStatus ? "visible" : "hidden";
            const manualTakeover = document.getElementById("manuallyTakeover");
            manualTakeover.style.visibility = onlineStatus ? "visible" : "hidden";
            const manualTakeoverList = document.getElementById("takeoverList");
            manualTakeoverList.style.visibility = onlineStatus ? "visible" : "hidden";
            console.log(manualTakeoverData)
            manualTakeoverList.innerHTML = manualTakeoverData;
            // manualTakeoverList.innerHTML = "hello";

        }
        function onlineToggle() {
            const uri = `${apiURL}/online`;
            const initDetails = {
                method: 'post',
                headers: {
                    "Access-Control-Allow-Origin": "*",
                    "Access-Control-Allow_Methods": "POST",
                    "Access-Control_Allow_Headers": "*",
                    "Content-Type": "application/json; charset=utf-8",
                    "Cache-Control": "no-cache"
                },
                mode: "cors",
                body: JSON.stringify({})
            };
            fetch(uri, initDetails).then(
                response => response.json()).then(result => {
                    retrieveJobs();
                }
            );
        }
        async function retrieveJobs() {
            const uri = `${apiURL}/scheduler/jobs`;
            const everythingUri = `${apiURL}/everything`;
            const initDetails = {
                method: 'get',
                headers: {
                    "Access-Control-Allow-Origin": "*",
                    "Access-Control-Allow_Methods": "GET",
                    "Access-Control_Allow_Headers": "*",
                    "Content-Type": "application/json; charset=utf-8",
                    "Cache-Control": "no-cache"
                },
                mode: "cors"
            };
            await fetch(uri, initDetails).then(response => response.json()).then(result => {
                console.log("rendering jobs");
                renderJobs(result);
            })
            await fetch(everythingUri, initDetails).then(response => response.json()).then(result => {
                console.log(result.manualTakeover)
                renderDoses(result.doses);
                renderReminders(result.reminders);
                renderOnlineStatus(result.onlineStatus, result.manualTakeover);
                manualTakeoverList = result.manualTakeover;
            })
        }
        function getEventsForPhoneNumber() {
            const phoneNumber = document.getElementById("messageSearchPhoneNumber").value;
            const days = document.getElementById("daysToPull").value;
            const uri = `${apiURL}/events?phoneNumber=${phoneNumber}&days=${days}`;
            const initDetails = {
                method: 'get',
                headers: {
                    "Access-Control-Allow-Origin": "*",
                    "Access-Control-Allow_Methods": "GET",
                    "Access-Control_Allow_Headers": "*",
                    "Content-Type": "application/json; charset=utf-8",
                    "Cache-Control": "no-cache"
                },
                mode: "cors"
            };
            fetch(uri, initDetails).then(response => response.json()).then(result => {
                renderEvents(result);
            });
        }
        // helper fn to get next alarm datetime from FE, not currently in use
        // function getAlarmStartTime(hour, minute) {
        //     var alarmTime  = new Date();
        //     const currentHour = alarmTime.getHours();
        //     const currentMinute = alarmTime.getMinutes();
        //     if (currentHour > hour || (currentHour == hour && currentMinute > minute)) {
        //         alarmTime.setDate(alarmTime.getDate() + 1);
        //     }
        //     alarmTime.setHours(hour);
        //     alarmTime.setMinutes(minute);
        //     alarmTime.setSeconds(0);
        //     alarmTime.setMilliseconds(0);
        //     const dateString = `${alarmTime.getFullYear()}-${alarmTime.getMonth() + 1}-${alarmTime.getDate()} ${alarmTime.getHours()}:${alarmTime.getMinutes()}:${alarmTime.getSeconds()}`;
        //     return dateString;
        // }
        function sendManual() {
            const reminderType = document.getElementById("reminderType").value;
            const doseId = document.getElementById("doseId").value;
            const body = { reminderType, doseId }
            const uri = `${apiURL}/manual`
            const initDetails = {
                method: 'post',
                headers: {
                    "Access-Control-Allow-Origin": "*",
                    "Access-Control-Allow_Methods": "POST",
                    "Access-Control_Allow_Headers": "*",
                    "Content-Type": "application/json; charset=utf-8",
                    "Cache-Control": "no-cache"
                },
                mode: "cors",
                body: JSON.stringify(body)
            };
            fetch(uri, initDetails).then(
                response => response.json()).then(result => {
                    retrieveJobs();
                }
            );
        }
        function createJob() {
            const startTime = document.getElementById("startTimeEntry").value;
            const splitStartTime = startTime.split(":");
            const startHour = convertToUTC(parseInt(splitStartTime[0]));
            const startMinute = parseInt(splitStartTime[1]);
            const endTime = document.getElementById("endTimeEntry").value;
            const splitEndTime = endTime.split(":");
            const endHour = convertToUTC(parseInt(splitEndTime[0]));
            const endMinute = parseInt(splitEndTime[1]);
            const phoneNumber = `1${document.getElementById("phoneNumberEntry").value}`;
            const patientName = document.getElementById("patientNameEntry").value;
            const medicationName = document.getElementById("medicationNameEntry").value;

            const uri = `${apiURL}/dose`;
            const body = {
                startHour,
                startMinute,
                endHour,
                endMinute,
                phoneNumber,
                medicationName,
                patientName
            };
            const initDetails = {
                method: 'post',
                headers: {
                    "Access-Control-Allow-Origin": "*",
                    "Access-Control-Allow_Methods": "POST",
                    "Access-Control_Allow_Headers": "*",
                    "Content-Type": "application/json; charset=utf-8",
                    "Cache-Control": "no-cache"
                },
                mode: "cors",
                body: JSON.stringify(body)
            };
            fetch(uri, initDetails).then(
                response => response.json()).then(result => {
                    console.log("posting job");
                    console.log(result);
                    retrieveJobs();
                }
            );
        }
        function deleteJob(id) {
            const uri = `${apiURL}/scheduler/jobs/${id}`;
            const initDetails = {
                method: 'delete',
                headers: {
                    "Access-Control-Allow-Origin": "*",
                    "Access-Control-Allow_Methods": "DELETE",
                    "Access-Control_Allow_Headers": "*",
                    "Cache-Control": "no-cache"
                },
                mode: "cors",
            };
            fetch(uri, initDetails).then(() => {
                retrieveJobs();
            })
        }
        function deleteDose(id) {
            const uri = `${apiURL}/dose`;
            const body = { id };
            const initDetails = {
                method: 'delete',
                headers: {
                    "Access-Control-Allow-Origin": "*",
                    "Access-Control-Allow_Methods": "DELETE",
                    "Access-Control_Allow_Headers": "*",
                    "Content-Type": "application/json; charset=utf-8",
                    "Cache-Control": "no-cache"
                },
                mode: "cors",
                body: JSON.stringify(body)
            };
            fetch(uri, initDetails).then(() => {
                retrieveJobs();
            });
        }
        function deleteReminder(id) {
            const uri = `${apiURL}/reminder`;
            const body = { id };
            const initDetails = {
                method: 'delete',
                headers: {
                    "Access-Control-Allow-Origin": "*",
                    "Access-Control-Allow_Methods": "DELETE",
                    "Access-Control_Allow_Headers": "*",
                    "Content-Type": "application/json; charset=utf-8",
                    "Cache-Control": "no-cache"
                },
                mode: "cors",
                body: JSON.stringify(body)
            };
            fetch(uri, initDetails).then(() => {
                retrieveJobs();
            });
        }
        function deleteEvent(id) {
            const uri = `${apiURL}/events`;
            const body = { id };
            const initDetails = {
                method: 'delete',
                headers: {
                    "Access-Control-Allow-Origin": "*",
                    "Access-Control-Allow_Methods": "DELETE",
                    "Access-Control_Allow_Headers": "*",
                    "Content-Type": "application/json; charset=utf-8",
                    "Cache-Control": "no-cache"
                },
                mode: "cors",
                body: JSON.stringify(body)
            };
            fetch(uri, initDetails).then(() => {
                getEventsForPhoneNumber();
            });
        }
        retrieveJobs();
    </script>
</body>